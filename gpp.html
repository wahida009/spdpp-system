<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <title>GPP | SPDPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font & Icon -->
  <script src="https://kit.fontawesome.com/a2e0e6d60a.js" crossorigin="anonymous"></script>

  <!-- Theme -->
  <link rel="stylesheet" href="style.css">

  <style>
    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      gap:12px;
      flex-wrap:wrap;
    }
    .top-bar input {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      min-width:220px;
    }
    .top-actions {
      display:flex;
      gap:10px;
    }
    .btn {
      background:#004aad;
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary {
      background:#eef3ff;
      color:#004aad;
      border:1px solid #cfe3ff;
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
    }
    th {
      background:#004aad;
      color:#fff;
      padding:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    td {
      padding:12px;
      border-bottom:1px solid #eef3ff;
      white-space:nowrap;
    }
    tr:hover td {
      background:#f7fbff;
    }
    .action-btn {
      padding:6px 10px;
      font-size:13px;
      border-radius:6px;
    }
  </style>

  <!-- ðŸ”¥ FIREBASE SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnyjKPVzeKu5w9X42ONnk8z9XsU6LPp4A",
      authDomain: "spdpp-310bc.firebaseapp.com",
      projectId: "spdpp-310bc",
      storageBucket: "spdpp-310bc.firebasestorage.app",
      messagingSenderId: "973564844896",
      appId: "1:973564844896:web:555597f8fdca461ca35c05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
  </script>
</head>

<body>

<!-- ðŸ”’ AUTH -->
<script>
if (localStorage.getItem("loggedIn") !== "true") {
  alert("Sila log masuk terlebih dahulu!");
  window.location.href = "login.html";
}
function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}
</script>

<!-- ðŸŸ¦ SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header"><h2>SPDPP</h2></div>
  <nav class="sidebar-nav">
    <a href="index.html">Laman Utama</a>
    <a href="gpp.html" class="active">GPP</a>
    <a href="perundangan.html">Perundangan</a>
    <a href="kajian.html">Kajian Perancangan</a>
  </nav>
  <button class="logout-btn" onclick="logout()">Log Keluar</button>
</aside>

<!-- ðŸŸ© MAIN -->
<main class="main-content">

  <h1>Garis Panduan Perancangan (GPP)</h1>

  <!-- TOP BAR -->
  <div class="top-bar">
    <input type="text" id="searchInput" placeholder="Cari Tajuk GPP...">

    <div class="top-actions">
      <button class="btn secondary" onclick="deleteSelected()">
        <i class="fas fa-trash"></i> Padam
      </button>

      <button class="btn" onclick="location.href='gppupload.html'">
        <i class="fas fa-plus"></i> Tambah Fail
      </button>
    </div>
  </div>

  <!-- TABLE -->
  <table id="gppTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Tajuk</th>
        <th>Mesyuarat</th>
        <th>Tahun</th>
        <th>Bil</th>
        <th>Tindakan</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

</main>

<!-- ðŸ”¥ MAIN SCRIPT -->
<script type="module">
import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let rawData = [];
let tableData = [];

/* LOAD DATA */
async function loadData() {
  const q = query(
    collection(window.db, "records"),
    where("kategori", "==", "GPP")
  );

  const snap = await getDocs(q);
  rawData = snap.docs.map(d => d.data());

  const map = {};
  rawData.forEach(r => {
    const key = `${r.tajuk}|${r.mesyuarat}|${r.tahun}|${r.bil}`;
    if (!map[key]) {
      map[key] = {
        tajuk: r.tajuk,
        mesy: r.mesyuarat,
        tahun: r.tahun,
        bil: r.bil
      };
    }
  });

  tableData = Object.values(map);
  renderTable();
}

/* RENDER TABLE */
function renderTable() {
  const body = document.getElementById("tableBody");
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  body.innerHTML = "";

  tableData
    .filter(d => d.tajuk.toLowerCase().includes(keyword))
    .forEach((d, i) => {
      body.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${d.tajuk}</td>
          <td>${d.mesy}</td>
          <td>${d.tahun}</td>
          <td>${d.bil}</td>
          <td>
            <button class="btn secondary action-btn"
              onclick="toggleFiles(${i})">
              Buka
            </button>
          </td>
        </tr>
      `;
    });
}

/* EXPAND FILE */
window.toggleFiles = function(index) {
  const d = tableData[index];
  const related = rawData.filter(r =>
    r.tajuk === d.tajuk &&
    r.mesyuarat === d.mesy &&
    r.tahun === d.tahun &&
    r.bil === d.bil
  );

  let html = `<tr><td colspan="6"><div class="file-box">`;
  related.forEach(f => {
    html += `
      <div class="tree-file">
        ${f.namaFail}
        <a class="btn secondary action-btn"
           href="${f.fileUrl}" target="_blank">
           Lihat
        </a>
      </div>`;
  });
  html += `</div></td></tr>`;

  document
    .getElementById("gppTable")
    .rows[index + 1]
    .insertAdjacentHTML("afterend", html);
};

/* SEARCH */
document.getElementById("searchInput")
  .addEventListener("input", renderTable);

/* PADAM (SAFE MODE) */
window.deleteSelected = function () {
  alert(
    "Fungsi Padam dikawal oleh pentadbir.\n\n" +
    "Pemadaman sebenar akan diaktifkan selepas kelulusan."
  );
};

/* INIT */
loadData();
</script>

</body>
</html>

