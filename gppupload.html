<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Muat Naik Fail GPP | SPDPP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnyjKPVzeKu5w9X42ONnk8z9XsU6LPp4A",
  authDomain: "spdpp-310bc.firebaseapp.com",
  projectId: "spdpp-310bc",
  storageBucket: "spdpp-310bc.appspot.com",
  messagingSenderId: "973564844896",
  appId: "1:973564844896:web:555597f8fdca461ca35c05"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const db = getFirestore(app);

window.submitUpload = async () => {

  const tajuk = document.getElementById("tajuk").value.trim();
  const mesy = document.getElementById("mesyuarat").value;
  const tahun = document.getElementById("tahun").value;
  const bil = document.getElementById("bil").value;
  const files = document.getElementById("files").files;
  const status = document.getElementById("status");

  if (!tajuk || !mesy || !tahun || files.length === 0) {
    alert("Sila lengkapkan semua maklumat");
    return;
  }

  status.innerText = "Memuat naik...";

  try {
    for (let f of files) {
      const path = `GPP/${tahun}/${mesy}/Bil_${bil}/${Date.now()}_${f.name}`;
      const fileRef = ref(storage, path);

      await uploadBytes(fileRef, f);
      const url = await getDownloadURL(fileRef);

      await addDoc(collection(db, "records"), {
        kategori: "GPP",
        tajuk,
        mesyuarat: mesy,
        tahun,
        bil,
        namaFail: f.name,
        fileUrl: url,
        createdAt: serverTimestamp()
      });
    }

    status.innerText = "✅ Fail berjaya dimuat naik";
    document.getElementById("uploadForm").reset();

  } catch (e) {
    console.error(e);
    alert("❌ Gagal muat naik");
    status.innerText = "";
  }
};
</script>
</head>

<body>

<main class="main-content">
<h1>Muat Naik Fail GPP</h1>

<form id="uploadForm" onsubmit="event.preventDefault(); submitUpload();">

<label>Tajuk GPP</label>
<input id="tajuk" required>

<label>Mesyuarat</label>
<select id="mesyuarat" required>
<option value="">-- Pilih --</option>
<option>JPP PLANM</option>
<option>JPP KPKT</option>
<option>MJM / NJM</option>
<option>MNKT</option>
</select>

<label>Tahun</label>
<select id="tahun">
<script>
for(let y=2026;y>=2006;y--) document.write(`<option>${y}</option>`);
</script>
</select>

<label>Bil</label>
<input type="number" id="bil" value="1">

<label>Fail</label>
<input type="file" id="files" multiple required>

<button type="submit">Muat Naik</button>
<p id="status"></p>

</form>
</main>

</body>
</html>
